{% extends 'base.html' %} {% block title %}Submit Report - Civic Issue Reporting System{% endblock %} {% block content %}
<div class="container">
    <div class="card">
        <div class="card-header">
            <h1 class="card-title">
                <i class="fas fa-plus"></i> Submit New Report
            </h1>
            <p class="card-subtitle">Report an issue in your community</p>
        </div>

        <div class="card-body">
            <form id="reportForm" enctype="multipart/form-data">
                <!-- Category Selection -->
                <div class="form-group">
                    <label for="category" class="form-label">
                        <i class="fas fa-tags"></i>
                        Category *
                    </label>
                    <select id="category" name="category" class="form-control" required>
                        <option value="">Select a category</option>
                        <option value="pothole">Potholes</option>
                        <option value="trash">Trash/Waste Management</option>
                        <option value="streetlight">Street Lighting</option>
                        <option value="water">Water Supply</option>
                        <option value="drainage">Drainage</option>
                        <option value="road">Road Maintenance</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Title -->
                <div class="form-group">
                    <label for="title" class="form-label">
                        <i class="fas fa-heading"></i>
                        Title *
                    </label>
                    <input type="text" id="title" name="title" class="form-control" placeholder="Brief description of the issue" required maxlength="200">
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="description" class="form-label">
                        <i class="fas fa-align-left"></i>
                        Description *
                    </label>
                    <textarea id="description" name="description" class="form-control" rows="4" placeholder="Detailed description of the issue" required></textarea>
                </div>

                <!-- Image Upload -->
                <div class="form-group">
                    <label for="image" class="form-label">
                        <i class="fas fa-camera"></i>
                        Photo (Optional)
                    </label>
                    <input type="file" id="image" name="image" class="form-control" accept="image/*" capture="environment">
                    <div id="imagePreview" class="image-preview"></div>
                </div>

                <!-- Location Section -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-map-marker-alt"></i>
                        Location *
                    </label>

                    <div class="location-controls">
                        <button type="button" id="getLocationBtn" class="btn btn-secondary">
                            <i class="fas fa-crosshairs"></i>
                            Use My Current Location
                        </button>
                        <div id="locationStatus" class="location-status"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <input type="hidden" id="latitude" name="latitude">
                            <input type="hidden" id="longitude" name="longitude">

                            <label for="address" class="form-label">Address</label>
                            <textarea id="address" name="address" class="form-control" rows="2" placeholder="Enter or confirm address" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <div id="locationMap" class="location-map">
                                <div class="map-placeholder">
                                    <i class="fas fa-map"></i>
                                    <p>Click "Use My Current Location" to show map</p>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="window.reportSubmission.showDefaultMap()">
                                        <i class="fas fa-map-marked-alt"></i>
                                        Show Map
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Priority Level -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-exclamation-triangle"></i>
                        Priority Level
                    </label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="priority" value="low" checked>
                            <span class="radio-custom"></span>
                            Low - Minor inconvenience
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="priority" value="medium">
                            <span class="radio-custom"></span>
                            Medium - Moderate issue
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="priority" value="high">
                            <span class="radio-custom"></span>
                            High - Safety concern
                        </label>
                    </div>
                </div>

                <!-- Submit Section -->
                <div class="form-actions">
                    <button type="submit" id="submitBtn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        Submit Report
                    </button>
                    <a href="/citizen/dashboard/" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
    class ReportSubmission {
        constructor() {
            this.map = null;
            this.marker = null;
            this.userLocation = null;
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.setupImagePreview();
        }

        setupEventListeners() {
            document.getElementById('getLocationBtn').addEventListener('click', () => {
                this.getCurrentLocation();
            });

            document.getElementById('reportForm').addEventListener('submit', (e) => {
                this.handleSubmit(e);
            });

            // Auto-update title based on category
            document.getElementById('category').addEventListener('change', (e) => {
                this.updateTitleSuggestion(e.target.value);
            });
        }

        setupImagePreview() {
            const imageInput = document.getElementById('image');
            const preview = document.getElementById('imagePreview');

            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.innerHTML = `
                        <div class="preview-container">
                            <img src="${e.target.result}" alt="Preview" class="preview-image">
                            <button type="button" class="remove-image" onclick="this.parentElement.parentElement.innerHTML=''; document.getElementById('image').value='';">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        updateTitleSuggestion(category) {
            const titleInput = document.getElementById('title');
            if (!titleInput.value) {
                const suggestions = {
                    'pothole': 'Pothole needs repair',
                    'streetlight': 'Street light not working',
                    'garbage': 'Garbage collection issue',
                    'water': 'Water supply problem',
                    'noise': 'Noise disturbance',
                    'graffiti': 'Graffiti removal needed',
                    'traffic': 'Traffic safety issue'
                };
                titleInput.placeholder = suggestions[category] || 'Brief description of the issue';
            }
        }

        getCurrentLocation() {
            const btn = document.getElementById('getLocationBtn');
            const status = document.getElementById('locationStatus');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        document.getElementById('latitude').value = this.userLocation.lat;
                        document.getElementById('longitude').value = this.userLocation.lng;

                        console.log('Location set:', this.userLocation.lat, this.userLocation.lng);

                        this.showMap();
                        this.reverseGeocode();

                        status.innerHTML = '<i class="fas fa-check text-success"></i> Location detected';
                        btn.innerHTML = '<i class="fas fa-sync"></i> Update Location';
                        btn.disabled = false;
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        status.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Unable to get location. You can click on the map to set location.';
                        this.showDefaultMap();
                        btn.innerHTML = '<i class="fas fa-crosshairs"></i> Try Again';
                        btn.disabled = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                status.innerHTML = '<i class="fas fa-times text-danger"></i> Geolocation not supported';
                this.showDefaultMap();
                btn.innerHTML = '<i class="fas fa-crosshairs"></i> Use My Current Location';
                btn.disabled = false;
            }
        }

        showMap() {
            const mapDiv = document.getElementById('locationMap');

            if (this.map) {
                this.map.remove();
            }

            mapDiv.innerHTML = '<div id="mapContainer" style="height: 200px; width: 100%;"></div>';

            this.map = L.map('mapContainer').setView([this.userLocation.lat, this.userLocation.lng], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(this.map);

            this.marker = L.marker([this.userLocation.lat, this.userLocation.lng])
                .addTo(this.map)
                .bindPopup('Report location')
                .openPopup();
            
            // Allow clicking on map to update location
            this.map.on('click', (e) => {
                this.updateLocationFromMap(e.latlng);
            });
        }
        
        showDefaultMap() {
            const mapDiv = document.getElementById('locationMap');
            
            if (this.map) {
                this.map.remove();
            }
            
            mapDiv.innerHTML = '<div id="mapContainer" style="height: 200px; width: 100%;"></div>';
            
            // Default to a central location (you can change this to your city)
            const defaultLat = 40.7589;
            const defaultLng = -73.9851;
            
            this.map = L.map('mapContainer').setView([defaultLat, defaultLng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(this.map);
            
            // Add instruction popup
            setTimeout(() => {
                const popup = L.popup()
                    .setLatLng([defaultLat, defaultLng])
                    .setContent('Click anywhere on the map to set your report location')
                    .openOn(this.map);
            }, 500);
            
            // Allow clicking on map to set location
            this.map.on('click', (e) => {
                this.updateLocationFromMap(e.latlng);
            });
            
            // Update status
            const status = document.getElementById('locationStatus');
            status.innerHTML = '<i class="fas fa-info-circle text-info"></i> Click on the map to set location';
        }
        
        updateLocationFromMap(latlng) {
            this.userLocation = {
                lat: latlng.lat,
                lng: latlng.lng
            };
            
            document.getElementById('latitude').value = this.userLocation.lat;
            document.getElementById('longitude').value = this.userLocation.lng;
            
            // Remove existing marker
            if (this.marker) {
                this.map.removeLayer(this.marker);
            }
            
            // Add new marker
            this.marker = L.marker([this.userLocation.lat, this.userLocation.lng])
                .addTo(this.map)
                .bindPopup('Report location')
                .openPopup();
            
            // Update status
            const status = document.getElementById('locationStatus');
            status.innerHTML = '<i class="fas fa-check text-success"></i> Location set from map';
            
            // Try to get address
            this.reverseGeocode();
        }

        async reverseGeocode() {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${this.userLocation.lat}&lon=${this.userLocation.lng}`
                );
                const data = await response.json();

                if (data.display_name) {
                    document.getElementById('address').value = data.display_name;
                }
            } catch (error) {
                console.error('Reverse geocoding failed:', error);
            }
        }

        async handleSubmit(e) {
            e.preventDefault();

            if (!this.validateForm()) {
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            try {
                const formData = new FormData();

                // Add form data
                formData.append('title', document.getElementById('title').value);
                formData.append('description', document.getElementById('description').value);
                formData.append('category', document.getElementById('category').value);
                formData.append('address', document.getElementById('address').value);
                formData.append('latitude', document.getElementById('latitude').value);
                formData.append('longitude', document.getElementById('longitude').value);
                formData.append('priority', document.querySelector('input[name="priority"]:checked').value);

                // Add image if selected
                const imageFile = document.getElementById('image').files[0];
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                // Debug: Log form data
                console.log('Submitting form data:');
                for (let [key, value] of formData.entries()) {
                    console.log(key, value);
                }

                const response = await fetch('/api/reports/create/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                if (response.ok) {
                    const responseData = JSON.parse(responseText);
                    console.log('Success response:', responseData);
                    showToast('Report submitted successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/citizen/dashboard/';
                    }, 1500);
                } else {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (parseError) {
                        errorData = { error: responseText || 'Server error occurred' };
                    }
                    console.error('API Error:', errorData);
                    throw new Error(errorData.error || errorData.message || 'Failed to submit report');
                }

            } catch (error) {
                console.error('Submit error:', error);
                showToast(error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        validateForm() {
            const requiredFields = ['title', 'description', 'category', 'address'];
            const missing = [];

            console.log('Validating form...');

            requiredFields.forEach(field => {
                const element = document.getElementById(field);
                console.log(`${field}:`, element.value);
                if (!element.value.trim()) {
                    missing.push(field);
                    element.classList.add('error');
                } else {
                    element.classList.remove('error');
                }
            });

            // Check location
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            console.log('Location:', lat, lng);

            if (!lat || !lng) {
                missing.push('location');
                const locationStatus = document.getElementById('locationStatus');
                locationStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Location is required - click "Use My Current Location" or "Show Map"';
                showToast('Please set your location by using GPS or clicking on the map.', 'error');
            } else {
                // Validate coordinate values
                const latNum = parseFloat(lat);
                const lngNum = parseFloat(lng);
                
                if (isNaN(latNum) || isNaN(lngNum) || latNum < -90 || latNum > 90 || lngNum < -180 || lngNum > 180) {
                    missing.push('location');
                    const locationStatus = document.getElementById('locationStatus');
                    locationStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Invalid location coordinates';
                    showToast('Invalid location coordinates. Please set location again.', 'error');
                }
            }

            console.log('Missing fields:', missing);

            if (missing.length > 0) {
                const missingFieldNames = missing.map(field => {
                    const labels = {
                        'title': 'Title',
                        'description': 'Description', 
                        'category': 'Category',
                        'address': 'Address',
                        'location': 'Location'
                    };
                    return labels[field] || field;
                });
                showToast(`Please fill in: ${missingFieldNames.join(', ')}`, 'error');
                return false;
            }

            return true;
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
        window.reportSubmission = new ReportSubmission();
    });
</script>

<style>
    .image-preview {
        margin-top: 10px;
    }
    
    .preview-container {
        position: relative;
        display: inline-block;
        max-width: 200px;
    }
    
    .preview-image {
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .remove-image {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    
    .location-controls {
        margin-bottom: 15px;
    }
    
    .location-status {
        margin-top: 10px;
        font-size: 14px;
    }
    
    .location-map {
        border: 1px solid var(--border);
        border-radius: 8px;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--background-light);
    }
    
    .map-placeholder {
        text-align: center;
        padding: 20px;
    }
    
    .map-placeholder i {
        font-size: 2rem;
        color: #ccc;
        margin-bottom: 10px;
    }
    
    .map-placeholder p {
        color: #666;
        margin-bottom: 15px;
    }
    
    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .radio-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
    }
    
    .radio-label input[type="radio"] {
        display: none;
    }
    
    .radio-custom {
        width: 18px;
        height: 18px;
        border: 2px solid var(--border);
        border-radius: 50%;
        margin-right: 10px;
        position: relative;
        transition: all 0.2s;
    }
    
    .radio-label input[type="radio"]:checked+.radio-custom {
        border-color: var(--primary);
        background: var(--primary);
    }
    
    .radio-label input[type="radio"]:checked+.radio-custom::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
    }
    
    .form-actions {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        justify-content: flex-end;
    }
    
    .error {
        border-color: var(--danger) !important;
        box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1) !important;
    }
    
    @media (max-width: 768px) {
        .form-actions {
            justify-content: stretch;
        }
        .form-actions .btn {
            flex: 1;
        }
    }
</style>
{% endblock %}